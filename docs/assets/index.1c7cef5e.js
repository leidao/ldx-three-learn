var $=Object.defineProperty;var V=(f,e,n)=>e in f?$(f,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):f[e]=n;var w=(f,e,n)=>(V(f,typeof e!="symbol"?e+"":e,n),n);import{r as R,j as O}from"./index.2628edae.js";import{L as Z,F as H,af as J,a1 as U,a7 as y,a2 as W,n as X,a9 as K,ag as Q,ah as L,ai as Y,M as E,z as T,O as P,u as A,t as B,x as M,B as ee,J as te,V as ne,aj as re,ak as oe,al as _,H as se,am as z,C as ie,ad as ae,an as ce,K as le,ao as de,ae as ue}from"./index.50da3779.js";const he=(f,e,n)=>{const{left:t,top:o,width:r,height:s}=e.getBoundingClientRect(),c=r/2,i=s/2,a=n.clone().project(f),p=Math.round(a.x*c+c)+t,m=Math.round(-a.y*i+i)+o;return{x:p,y:m}};class pe extends Z{constructor(e){super(e)}load(e,n,t,o){const r=this,s=new H(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(r.withCredentials),s.load(e,function(c){let i;try{i=JSON.parse(c)}catch{console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(c.substring(65,c.length-2))}const a=r.parse(i);n&&n(a)},t,o)}parse(e){return new G(e)}}class G{constructor(e){this.type="Font",this.data=e}generateShapes(e,n=100){const t=[],o=fe(e,n,this.data);for(let r=0,s=o.length;r<s;r++)Array.prototype.push.apply(t,o[r].toShapes());return t}}function fe(f,e,n){const t=Array.from(f),o=e/n.resolution,r=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*o,s=[];let c=0,i=0;for(let a=0;a<t.length;a++){const p=t[a];if(p===`
`)c=0,i-=r;else{const m=me(p,o,c,i,n);c+=m.offsetX,s.push(m.path)}}return s}function me(f,e,n,t,o){const r=o.glyphs[f]||o.glyphs["?"];if(!r){console.error('THREE.Font: character "'+f+'" does not exists in font family '+o.familyName+".");return}const s=new J;let c,i,a,p,m,v,d,u;if(r.o){const h=r._cachedOutline||(r._cachedOutline=r.o.split(" "));for(let l=0,g=h.length;l<g;)switch(h[l++]){case"m":c=h[l++]*e+n,i=h[l++]*e+t,s.moveTo(c,i);break;case"l":c=h[l++]*e+n,i=h[l++]*e+t,s.lineTo(c,i);break;case"q":a=h[l++]*e+n,p=h[l++]*e+t,m=h[l++]*e+n,v=h[l++]*e+t,s.quadraticCurveTo(m,v,a,p);break;case"b":a=h[l++]*e+n,p=h[l++]*e+t,m=h[l++]*e+n,v=h[l++]*e+t,d=h[l++]*e+n,u=h[l++]*e+t,s.bezierCurveTo(m,v,d,u,a,p);break}}return{offsetX:r.ha*e,path:s}}G.prototype.isFont=!0;class we extends U{constructor(e=document.createElement("div")){super(),this.element=e,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(n){n.element instanceof Element&&n.element.parentNode!==null&&n.element.parentNode.removeChild(n.element)})})}copy(e,n){return super.copy(e,n),this.element=e.element.cloneNode(!0),this}}we.prototype.isCSS2DObject=!0;const b=new y,k=new W,D=new W,N=new y,j=new y;class ve{constructor(e={}){const n=this;let t,o,r,s;const c={objects:new WeakMap},i=e.element!==void 0?e.element:document.createElement("div");i.style.overflow="hidden",this.domElement=i,this.getSize=function(){return{width:t,height:o}},this.render=function(d,u){d.autoUpdate===!0&&d.updateMatrixWorld(),u.parent===null&&u.updateMatrixWorld(),k.copy(u.matrixWorldInverse),D.multiplyMatrices(u.projectionMatrix,k),a(d,d,u),v(d)},this.setSize=function(d,u){t=d,o=u,r=t/2,s=o/2,i.style.width=d+"px",i.style.height=u+"px"};function a(d,u,h){if(d.isCSS2DObject){d.onBeforeRender(n,u,h),b.setFromMatrixPosition(d.matrixWorld),b.applyMatrix4(D);const l=d.element;/apple/i.test(navigator.vendor)?l.style.transform="translate(-50%,-50%) translate("+Math.round(b.x*r+r)+"px,"+Math.round(-b.y*s+s)+"px)":l.style.transform="translate(-50%,-50%) translate("+(b.x*r+r)+"px,"+(-b.y*s+s)+"px)",l.style.display=d.visible&&b.z>=-1&&b.z<=1?"":"none";const g={distanceToCameraSquared:p(h,d)};c.objects.set(d,g),l.parentNode!==i&&i.appendChild(l),d.onAfterRender(n,u,h)}for(let l=0,g=d.children.length;l<g;l++)a(d.children[l],u,h)}function p(d,u){return N.setFromMatrixPosition(d.matrixWorld),j.setFromMatrixPosition(u.matrixWorld),N.distanceToSquared(j)}function m(d){const u=[];return d.traverse(function(h){h.isCSS2DObject&&u.push(h)}),u}function v(d){const u=m(d).sort(function(l,g){const x=c.objects.get(l).distanceToCameraSquared,S=c.objects.get(g).distanceToCameraSquared;return x-S}),h=u.length;for(let l=0,g=u.length;l<g;l++)u[l].element.style.zIndex=h-l}}}class ge{constructor(e){w(this,"clock");w(this,"textLoader");w(this,"fileLoader");w(this,"fontLoad");w(this,"viewer");w(this,"uniforms",{});w(this,"labelRenderer");w(this,"controls");w(this,"createEarth",e=>{this.textLoader.load("propagate/img/earth.png",n=>{const t=new Y(e,100,100),o=new E({map:n,opacity:1}),r=new T(t,o);this.viewer.scene.add(r),this.render()})});w(this,"drawOutline",()=>{const e=new P,n=new P,t=new E({color:"#ffffff",side:A,transparent:!0,opacity:.35}),o=new B({color:16777215,transparent:!0,opacity:.1});this.fileLoader.load("propagate/data/world.json",r=>{r.features.forEach(s=>{if(s.geometry.type==="Polygon"){const c=[],i=s.geometry.coordinates[0]||[];if(i.length===0)return;i.forEach(a=>{c.push(a[0],a[1],0)}),e.add(this.drawLineLoop(c,o)),n.add(this.drawShpae(i,t))}else s.geometry.type==="MultiPolygon"&&s.geometry.coordinates.forEach(c=>{const i=[],a=c[0]||[];a.length!==0&&(a.forEach(p=>{i.push(p[0],p[1],0)}),e.add(this.drawLineLoop(i,o)),n.add(this.drawShpae(a,t)))})}),this.viewer.scene.add(e),this.viewer.scene.add(n),this.render()})});w(this,"drawLineLoop",(e,n)=>{const t=new M,o=new Float32Array(e);return t.setAttribute("position",new ee(o,3)),new te(t,n)});w(this,"drawShpae",(e,n)=>{const t=[];e.forEach(c=>{t.push(new ne(c[0],c[1]))});const o=new re(t),r=new oe(o);return new T(r,n)});w(this,"drawLines",e=>{const n=new B({color:14737632});e.forEach(t=>{const{from:o,to:r,name:s,isLine:c}=t;if(!r||!c||s==="\u66F2\u961C")return;const i=new y(o[0],o[1],0),a=new y(r[0],r[1],0),p=i.clone().lerp(a,.5),m=i.clone().distanceTo(a);p.z+=m/3;const v=m*4,u=new _(i,p,a).getPoints(v),h=new M().setFromPoints(u),l=new se(h,n);this.viewer.scene.add(l),this.render()})});w(this,"drawFlyLine",e=>{e.forEach(n=>{const{from:t,to:o,name:r,isLine:s}=n;if(!o||!s||r==="\u66F2\u961C")return;const c=[],i=[],a=[],p=[],m=new y(t[0],t[1],0),v=new y(o[0],o[1],0),d=m.clone().lerp(v,.5),u=m.clone().distanceTo(v);d.z+=u/3;const h=u*8,g=new _(m,d,v).getPoints(h);g.forEach((C,F)=>{const I=F/(h-1);c.push({x:C.x,y:C.y,z:C.z}),a.push(I),p.push(F)}),c.forEach(C=>{i.push(C.x,C.y,C.z)});const x=new M;x.setFromPoints(g),x.setAttribute("position",new z(i,3)),x.setAttribute("index",new z(a,1)),x.setAttribute("current",new z(p,1)),this.uniforms[r]={uColor:{value:new ie(710128)},uRange:{value:20},uSize:{value:3},uTotal:{value:h},uTime:{value:0},uSpeed:{value:(Math.random()*4+4)/10}};const S=new ae({transparent:!0,depthWrite:!1,depthTest:!1,blending:ce,uniforms:this.uniforms[r],vertexShader:`
        attribute float index;
        attribute float current;
        uniform float uTime;
        uniform float uSize;
        uniform float uSpeed;
        uniform float uRange; // \u5C55\u793A\u533A\u95F4
        uniform float uTotal; // \u7C92\u5B50\u603B\u6570
        uniform vec3 uColor;
        varying vec3 vColor;
        varying float vOpacity;
        void main() {
            // \u9700\u8981\u5F53\u524D\u663E\u793A\u7684\u7D22\u5F15
            float size = uSize;
            float showNumber = uTotal * mod(uTime * uSpeed, 1.1);
            if (showNumber > current && showNumber < current + uRange) {
                float uIndex = ((current + uRange) - showNumber) / uRange;
                size *= uIndex;
                vOpacity = 1.0;
            } else {
                vOpacity = 0.0;
            }
            // \u9876\u70B9\u7740\u8272\u5668\u8BA1\u7B97\u540E\u7684Position
            vColor = uColor;
            vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
            gl_Position = projectionMatrix * mvPosition;
            // \u5927\u5C0F
            gl_PointSize = size * 300.0 / (-mvPosition.z);
        }`,fragmentShader:`
        varying vec3 vColor;
        varying float vOpacity;
        void main() {
            float distanceToCenter = distance(gl_PointCoord,vec2(0.5));
            float strength = 1.0 - (distanceToCenter * 2.0);
            if(vOpacity <= 0.0){
              gl_FragColor = vec4(vColor, 0.0);
            }else{
              gl_FragColor = vec4(vColor, strength);
            }
        }`}),q=new le(x,S);this.viewer.scene.add(q)})});w(this,"drawLocation",(e,n=!1)=>{const t=new E({transparent:!0,side:A});this.textLoader.load("propagate/img/136.png",o=>{e.forEach(r=>{const{to:s,size:c}=r,i=Number(c)+2,a=n?c:i>16?16:i;if(!s)return;const{x:p,y:m,z:v}=new y(s[0],s[1],0),d=new de(a,a);t.map=o;const u=new T(d,t);u.position.set(p,m,v+.02),this.viewer.scene.add(u)}),this.render()})});w(this,"update",()=>{const e=this.clock.getElapsedTime();Object.keys(this.uniforms).forEach(n=>{this.uniforms[n].uTime.value=e}),this.render()});this.viewer=e,this.textLoader=new X(this.viewer.loadmanager),this.textLoader.setCrossOrigin(""),this.fileLoader=new H(this.viewer.loadmanager),this.fileLoader.setResponseType("json"),this.fontLoad=new pe,this.clock=new K,this.uniforms={}}useCss3Render(e){const{width:n,height:t}=this.viewer.container.getBoundingClientRect();this.labelRenderer=new ve,this.labelRenderer.setSize(n,t),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0px";const o=this.labelRenderer.domElement;o.id="tempId",document.body.appendChild(this.labelRenderer.domElement),this.controls=new Q(this.viewer.camera,this.labelRenderer.domElement),this.controls.addEventListener("change",()=>{this.render();const r=new y;this.viewer.camera.getWorldPosition(r),this.createText(e,r.z)}),this.controls.enableRotate=!1,this.controls.minDistance=50,this.controls.maxDistance=200,this.controls.mouseButtons={LEFT:L.PAN,MIDDLE:L.DOLLY,RIGHT:L.ROTATE}}startGame(){this.loadSky(),this.drawOutline(),this.drawLocation([{to:[117.045982,35.794391],size:35}],!0),this.fileLoader.load("propagate/data/map.json",e=>{this.drawLines(e),this.drawFlyLine(e),this.createText(e),this.drawLocation(e),this.useCss3Render(e),this.viewer.scene.translateX(-10),this.viewer.scene.translateY(-15)})}render(){this.viewer.render()}loadSky(){this.textLoader.load("propagate/img/bg.png",e=>{this.viewer.scene.background=e,this.render()})}createText(e,n=180){e.forEach(t=>{const{to:o,name:r,size:s,isLine:c}=t;if(!r||!c||!o)return;const i=new y(o[0]-10,o[1]-15,0),a=he(this.viewer.camera,this.viewer.container,i);t.div||(t.div=document.createElement("div"),t.div.style.fontSize=r==="\u66F2\u961C"?"30px":"22px",t.div.style.color="#ffffff",t.div.style.position="absolute",t.div.style.fontFamily="HanaA",t.div.style.whiteSpace="nowrap"),t.div.style.transform=`scale(${100/n})`;let p=`<span>${r}</span> `;s>1&&(p+=`<span style="font-size:38px;vertical-align: sub;">${s}</span> <span>\u6240</span>`),t.div.innerHTML=p,this.viewer.container.appendChild(t.div),t.div.style.left=`${a.x-t.div.clientWidth/2}px`,t.div.style.top=`${a.y-t.div.clientHeight/2}px`,r=="\u66F2\u961C"&&(t.div.style.left=`${a.x-t.div.clientWidth/2+15}px`,t.div.style.top=`${a.y-t.div.clientHeight/2+(40+s/8-n/12)}px`)})}}const Ce=()=>{const f=R.exports.useRef(null);return R.exports.useEffect(()=>{if(!f.current)return;const e=new ue(f.current);e.useOrbitControls(),e.listen();const n=new ge(e);n.startGame();let t;const o=()=>{n.update(),t=requestAnimationFrame(o)};return o(),()=>{cancelIdleCallback(t)}},[]),O("div",{className:"w-100% h-100% relative",children:O("div",{className:"gunplay w-100% h-100%",ref:f})})};export{Ce as default};
